<% layout("/layouts/boilerplate") %>

<body>
 <div class="row">
            <div class="col-8 offset-2">
         <br><br>
        <h1>Edit Form</h1>

                <!-- Display flash messages -->
                <% if(locals.messages && Object.keys(messages).length > 0) { %>
                    <% Object.keys(messages).forEach(type => { %>
                        <% messages[type].forEach(msg => { %>
                            <div class="alert alert-<%= type === 'error' ? 'danger' : type %>" role="alert">
                                <%= msg %>
                            </div>
                            <% }); %>
                                <% }); %>
                                    <% } %>

                                        <form method="post" action="/listings/<%= listdata._id%>?_method=PUT"
                                            class="needs-validation" novalidate enctype="multipart/form-data"
                                            id="edit-listing-form">
        <div>
            <label for="title" class="form-label">Title</label>
                                                <input type="text" name="listing[title]" value="<%=listdata.title%>"
                                                    class="form-control" required>
            <div class="valid-feedback">Titles look good</div>
            <div class="invalid-feedback">Title Should be Valid</div>
        </div>
        <div>
            <label for="description" class="form-label">Description</label>
                                                <textarea type="text" name="listing[description]" class="form-control"
                                                    required><%= listdata.description %></textarea>
            <div class="invalid-feedback">Description give in Short</div>
        </div>
                                            <div class="mb-3">
                                                <h5>Current Main Image</h5>
                                                <% if (originalimageurl) { %>
                                                    <img src="<%= originalimageurl %>" alt="Main image"
                                                        class="img-thumbnail" style="max-width: 300px;">
                                                    <% } else { %>
                                                        <p class="text-muted">No main image uploaded</p>
                                                        <% } %>
                                            </div>

                                            <!-- Display existing additional images -->
                                            <% if (locals.additionalImagesUrls && additionalImagesUrls.length > 0) { %>
                                                <div class="mb-3">
                                                    <h5>Additional Images</h5>
                                                    <div class="row">
                                                        <% additionalImagesUrls.forEach((imageUrl, index) => { %>
                                                            <div class="col-md-3 mb-3">
                                                                <div class="card">
                                                                    <img src="<%= imageUrl %>" class="card-img-top"
                                                                        alt="Additional Image <%= index + 1 %>"
                                                                        style="height: 200px; object-fit: cover;">
                                                                    <div class="card-body p-2">
                                                                        <form method="POST"
                                                                            action="/listings/<%= listdata._id %>/images/<%= index %>?_method=DELETE"
                                                                            class="d-inline">
                                                                            <button type="submit"
                                                                                class="btn btn-danger btn-sm"
                                                                                onclick="return confirm('Are you sure you want to delete this image?')">Delete</button>
                                                                        </form>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% }); %>
                                                    </div>
                                                </div>
                                                <% } %>

                                                    <div class="mb-3">
                                                        <label for="main-image-update" class="form-label">Update Main
                                                            Image</label>
                                                        <input type="file" id="main-image-update" name="image"
                                                            class="form-control" accept="image/*">
                                                        <small class="form-text text-muted">Leave empty to keep current
                                                            main image</small>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label for="additional-images-update" class="form-label"><strong
                                                                style="color: #dc3545;">Replace All Additional
                                                                Images</strong></label>
                                                        <input type="file" id="additional-images-update"
                                                            name="additionalImages" class="form-control"
                                                            accept="image/*" multiple>
                                                        <div class="alert alert-warning mt-2">
                                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                                            <strong>Important:</strong> Selecting new images below will
                                                            <strong>COMPLETELY REPLACE</strong> all existing additional
                                                            images.
                                                            The old images will be permanently deleted from our storage.
                                                            To keep any existing images, you must select them again
                                                            along with any new images.
                                                        </div>
                                                        <div id="file-count-edit" class="small text-info mt-1"></div>
        </div>
        <div class="row">
            <div class="col-md-4">
               <label for="price" class="form-label">Price</label>
                                                            <input name="listing[price]" value="<%= listdata.price %>"
                                                                type="number" class="form-control" required>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="accommodates" class="form-label">Accommodates
                                                                (capacity)</label>
                                                            <input name="listing[accommodates]"
                                                                value="<%= listdata.accommodates || 1 %>" type="number"
                                                                min="1" class="form-control" required>
            </div>
            <div class="invalid-feedback">Price Should be Valid</div>
           <div class="col-md-8">
            <label for="country" class="form-label">Country</label>
                                                            <input type="text" name="listing[country]"
                                                                value="<%=listdata.country%>" class="form-control"
                                                                required>
            </div> 
            <div class="invalid-feedback">Country Should be Valid</div>
        </div>
                                                    <div class="row mt-3">
                                                        <div class="col-md-4">
                                                            <label for="propertyType" class="form-label">Property
                                                                type</label>
                                                            <select name="listing[propertyType]" id="propertyType"
                                                                class="form-select" required>
                                                                <option value="Entire place"
                                                                    <%=listdata.propertyType==='Entire place'
                                                                    ? 'selected' : '' %>>Entire place</option>
                                                                <option value="Private room"
                                                                    <%=listdata.propertyType==='Private room'
                                                                    ? 'selected' : '' %>>Private room</option>
                                                                <option value="Shared room"
                                                                    <%=listdata.propertyType==='Shared room'
                                                                    ? 'selected' : '' %>>Shared room</option>
                                                                <option value="Hotel room"
                                                                    <%=listdata.propertyType==='Hotel room' ? 'selected'
                                                                    : '' %>>Hotel room</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label for="bedrooms" class="form-label">Bedrooms</label>
                                                            <input type="number" min="0" name="listing[bedrooms]"
                                                                class="form-control"
                                                                value="<%= listdata.bedrooms || 1 %>" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label for="bathrooms" class="form-label">Bathrooms</label>
                                                            <input type="number" step="0.5" min="0.5"
                                                                name="listing[bathrooms]" class="form-control"
                                                                value="<%= listdata.bathrooms || 1 %>" required>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <label for="beds" class="form-label">Beds</label>
                                                            <input type="number" min="1" name="listing[beds]"
                                                                class="form-control" value="<%= listdata.beds || 1 %>"
                                                                required>
                                                        </div>
                                                    </div>

                                                    <div class="mt-3">
                                                        <label class="form-label">Amenities</label>
                                                        <div class="row">
                                                            <div class="col-md-12 d-flex flex-wrap gap-3">
                                                                <% const amenities=['WiFi','Kitchen','Washer','Dryer','Air conditioning','Heating','TV','Hair dryer','Iron','Laptop-friendly workspace','Pool','Hot tub','Free parking','Gym','Breakfast','Pets allowed','Smoking allowed','Suitable for events','Family/kid friendly','Wheelchair accessible','Elevator','Fireplace','Buzzer/wireless intercom','Doorman','Shampoo','Essentials','Hangers','Translation missing','Carbon monoxide detector','Smoke detector','First aid kit','Fire extinguisher','Lock on bedroom door']; %>
                                                                    <% amenities.forEach(a => { %>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input"
                                                                                type="checkbox"
                                                                                name="listing[amenities]"
                                                                                value="<%= a %>" id="amenity-<%= a %>"
                                                                                <%=(listdata.amenities||[]).includes(a)?'checked':''
                                                                                %>>
                                                                            <label class="form-check-label"
                                                                                for="amenity-<%= a %>">
                                                                                <%= a %>
                                                                            </label>
                                                                        </div>
                                                                        <% }) %>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="row mt-3">
                                                        <div class="col-md-3">
                                                            <label class="form-label">Check-in</label>
                                                            <input type="text" name="listing[houseRules][checkIn]"
                                                                class="form-control"
                                                                value="<%= listdata.houseRules?.checkIn || '' %>">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Check-out</label>
                                                            <input type="text" name="listing[houseRules][checkOut]"
                                                                class="form-control"
                                                                value="<%= listdata.houseRules?.checkOut || '' %>">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Min stay (nights)</label>
                                                            <input type="number" min="1"
                                                                name="listing[houseRules][minStay]" class="form-control"
                                                                value="<%= listdata.houseRules?.minStay || 1 %>">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <label class="form-label">Max stay (nights)</label>
                                                            <input type="number" min="1"
                                                                name="listing[houseRules][maxStay]" class="form-control"
                                                                value="<%= listdata.houseRules?.maxStay || 1125 %>">
                                                        </div>
                                                    </div>

                                                    <div class="row mt-2">
                                                        <div class="col-md-3 form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="listing[houseRules][smokingAllowed]"
                                                                id="smokingAllowed"
                                                                <%= listdata.houseRules?.smokingAllowed ? 'checked' : '' %>>
                                                            <label class="form-check-label" for="smokingAllowed">Smoking
                                                                allowed</label>
                                                        </div>
                                                        <div class="col-md-3 form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="listing[houseRules][petsAllowed]" id="petsAllowed"
                                                                <%= listdata.houseRules?.petsAllowed ? 'checked' : '' %>>
                                                            <label class="form-check-label" for="petsAllowed">Pets
                                                                allowed</label>
                                                        </div>
                                                        <div class="col-md-3 form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="listing[houseRules][eventsAllowed]"
                                                                id="eventsAllowed" 
                                                                <%= listdata.houseRules?.eventsAllowed ? 'checked' : '' %>>
                                                            <label class="form-check-label" for="eventsAllowed">Events
                                                                allowed</label>
                                                        </div>
                                                    </div>

                                                    <div class="row mt-3">
                                                        <div class="col-md-3 form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                name="listing[availability][instantBook]"
                                                                id="instantBook" 
                                                                <%= listdata.availability?.instantBook ? 'checked' : '' %>>
                                                            <label class="form-check-label" for="instantBook">Instant
                                                                book</label>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Min advance notice</label>
                                                            <select class="form-select"
                                                                name="listing[availability][minAdvanceNotice]">
                                                                <% const minOpts=['Same day','1 day','2 days','3 days','1 week']; %>
                                                                    <% minOpts.forEach(o => { %>
                                                                        <option <%= (listdata.availability?.minAdvanceNotice === o) ? 'selected' : '' %>>
                                                                            <%= o %>
                                                                        </option>
                                                                        <% }) %>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label class="form-label">Max advance notice</label>
                                                            <select class="form-select"
                                                                name="listing[availability][maxAdvanceNotice]">
                                                                <% const maxOpts=['3 months','6 months','9 months','12 months','All dates available']; %>
                                                                    <% maxOpts.forEach(o => { %>
                                                                        <option <%= (listdata.availability?.maxAdvanceNotice === o) ? 'selected' : '' %>>
                                                                            <%= o %>
                                                                        </option>
                                                                        <% }) %>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-2 mt-2">
                                                            <label for="category">Category</label>
                                                            <br>
                                                            <select name="listing[category]" id="category" required>
                                                                <option disabled <%=!listdata.category ? 'selected' : ''
                                                                    %>>Select a category</option>
                                                                <option value="Trending"
                                                                    <%=listdata.category==='Trending' ? 'selected' : ''
                                                                    %>>Trending</option>
                                                                <option value="Rooms" <%=listdata.category==='Rooms'
                                                                    ? 'selected' : '' %>>Rooms</option>
                                                                <option value="Mountain Cities"
                                                                    <%=listdata.category==='Mountain Cities'
                                                                    ? 'selected' : '' %>>Mountain Cities</option>
                                                                <option value="Castles" <%=listdata.category==='Castles'
                                                                    ? 'selected' : '' %>>Castles</option>
                                                                <option value="Swimming Pools"
                                                                    <%=listdata.category==='Swimming Pools' ? 'selected'
                                                                    : '' %>>Swimming Pools</option>
                                                                <option value="Camping Ground"
                                                                    <%=listdata.category==='Camping Ground' ? 'selected'
                                                                    : '' %>>Camping Ground</option>
                                                                <option value="Cow Farms"
                                                                    <%=listdata.category==='Cow Farms' ? 'selected' : ''
                                                                    %>>Cow Farms</option>
                                                                <option value="Bus Side"
                                                                    <%=listdata.category==='Bus Side' ? 'selected' : ''
                                                                    %>>Bus Side</option>
                                                                <option value="Sea Beaches"
                                                                    <%=listdata.category==='Sea Beaches' ? 'selected'
                                                                    : '' %>>Sea Beaches</option>
                                                                <option value="Vacant" <%=listdata.category==='Vacant'
                                                                    ? 'selected' : '' %>>Vacant</option>
                                                                <option value="Hotel" <%=listdata.category==='Hotel'
                                                                    ? 'selected' : '' %>>Hotel</option>
                                                            </select>

                                                        </div>
                                                        <div class="col-md-10">
            <label for="location" class="form-label">Location</label>
                                                            <input type="text" name="listing[location]"
                                                                value="<%= listdata.location %>" class="form-control"
                                                                required>
                                                            <div class="invalid-feedback">Location Should be Valid</div>
                                                        </div>
        </div>
        <br><br>
                                                    <button class="btn btn-dark add-button"
                                                        type="submit">Submit</button>
    </form>

                                        <!-- Add debug script to track form submission -->
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                const form = document.getElementById('edit-listing-form');
                                                if (form) {
                                                    console.log('Edit listing form found, adding submission handler');

                                                    form.addEventListener('submit', function (e) {
                                                        console.log('Form submission detected');

                                                        // Log file inputs
                                                        const fileInputs = form.querySelectorAll('input[type="file"]');
                                                        fileInputs.forEach(input => {
                                                            console.log(`File input ${input.name}:`, input.files.length, 'files selected');
                                                            if (input.files.length > 0) {
                                                                Array.from(input.files).forEach((file, i) => {
                                                                    console.log(` - File ${i + 1}:`, file.name, `(${Math.round(file.size / 1024)}KB)`);
                                                                });
                                                            }
                                                        });

                                                        // Confirm image replacement
                                                        const additionalImagesInput = document.getElementById('additional-images-update');
                                                        if (additionalImagesInput && additionalImagesInput.files.length > 0) {
                                                            console.log('REPLACING ALL ADDITIONAL IMAGES with', additionalImagesInput.files.length, 'new files');
                                                            const confirmReplace = confirm(
                                                                `You are about to REPLACE ALL existing additional images with ${additionalImagesInput.files.length} new images.\n\n` +
                                                                'Any existing additional images will be PERMANENTLY LOST.\n\n' +
                                                                'Are you sure you want to continue?'
                                                            );

                                                            if (!confirmReplace) {
                                                                console.log('Image replacement cancelled by user');
                                                                e.preventDefault();
                                                                return false;
                                                            }

                                                            console.log('Image replacement confirmed by user');
                                                        }
                                                    });
                                                } else {
                                                    console.error('Edit listing form not found');
                                                }
                                            });
                                        </script>
    </div>
    <br><br>
            <script>
                window.addEventListener("load", function () {
                    console.log("=== FILE UPLOAD SCRIPT LOADED AFTER FULL PAGE ===");
                    console.log("Current URL:", window.location.pathname);

                    // Find ALL file inputs
                    const allFileInputs = document.querySelectorAll("input[type='file']");
                    console.log("Total file inputs found:", allFileInputs.length);

                    allFileInputs.forEach((input, index) => {
                        console.log(`File input ${index + 1}:`, {
                            id: input.id,
                            name: input.name,
                            multiple: input.multiple,
                            accept: input.accept
                        });

                        // Attach event listener
                        input.addEventListener("change", e => {
                            const files = e.target.files;
                            console.log(`Files selected in ${input.id || input.name}:`, files.length);

                            if (files.length > 0) {
                                Array.from(files).forEach((file, idx) => {
                                    console.log(`  ${idx + 1}. ${file.name} (${file.type}, ${(file.size / 1024).toFixed(2)} KB)`);
                                });
                            }

                            // Status handling for additional images only
                            if (input.id === "additional-images-update") {
                                let statusDiv = document.getElementById("file-count-edit");
                                if (statusDiv) {
                                    if (files.length > 10) {
                                        statusDiv.textContent = `Too many files! Please select max 10 (selected ${files.length})`;
                                        statusDiv.className = "small text-danger mt-1";
                                    } else {
                                        statusDiv.textContent = `${files.length} image(s) selected`;
                                        statusDiv.className = "small text-success mt-1";
                                    }
                                }
                            }
                        });
                    });

                    console.log("=== FILE UPLOAD SETUP COMPLETED ===");

                    // Intercept form submission for debug
                    document.addEventListener("submit", function (e) {
                        const form = e.target;
                        if (form.enctype === "multipart/form-data") {
                            console.log("=== FORM SUBMISSION DETECTED ===");
                            console.log("Form action:", form.action);
                            console.log("Form method:", form.method);

                            const formData = new FormData(form);
                            console.log("Form data entries:");
                            for (let [key, value] of formData.entries()) {
                                if (value instanceof File) {
                                    console.log(`  ${key}: File - ${value.name} (${value.type}, ${value.size} bytes)`);
                                } else {
                                    console.log(`  ${key}: ${value}`);
                                }
                            }
                        }
                    });
                });
            </script>
            <!-- ===================================================== -->
        </div>
    </body>
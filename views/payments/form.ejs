<% layout("layouts/boilerplate") %>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">Complete Payment</h2>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Booking Summary</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <img src="<%= booking.listing.image.url %>" class="img-fluid rounded" alt="<%= booking.listing.title %>">
                        </div>
                        <div class="col-md-8">
                            <h6><%= booking.listing.title %></h6>
                            <p class="text-muted">
                                <i class="bi bi-geo-alt"></i> <%= booking.listing.location %>
                            </p>
                            <p>
                                <strong>Dates:</strong> 
                                <%= new Date(booking.checkIn).toLocaleDateString() %> - 
                                <%= new Date(booking.checkOut).toLocaleDateString() %><br>
                                <strong>Guests:</strong> <%= booking.guests.adults %> adults
                                <% if(booking.guests.children > 0) { %>, <%= booking.guests.children %> children<% } %>
                                <% if(booking.guests.infants > 0) { %>, <%= booking.guests.infants %> infants<% } %><br>
                                <strong>Host:</strong> <%= booking.host.username %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Price Breakdown</h5>
                    <div class="d-flex justify-content-between">
                        <span>$<%= booking.listing.price %> x <%= booking.nights %> nights</span>
                        <span>$<%= booking.listing.price * booking.nights %></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Service fee</span>
                        <span>$<%= Math.round((booking.listing.price * booking.nights) * 0.14) %></span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Total (USD)</span>
                        <span>$<%= booking.totalPrice %></span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Payment Method</h5>
                    <p class="text-info">
                        <i class="bi bi-info-circle"></i> 
                        This is a demo payment system. No real payment will be processed.
                    </p>
                    
                    <form method="POST" action="/payments/process" id="payment-form">
                        <input type="hidden" name="bookingId" value="<%= booking._id %>">
                        
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                       id="card" value="card" checked>
                                <label class="form-check-label" for="card">
                                    <i class="bi bi-credit-card"></i> Credit/Debit Card (Demo)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" 
                                       id="paypal" value="paypal">
                                <label class="form-check-label" for="paypal">
                                    <i class="bi bi-paypal"></i> PayPal (Demo)
                                </label>
                            </div>
                        </div>

                        <div id="card-details" class="payment-details">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="cardNumber" class="form-label">Card Number</label>
                                        <input type="text" class="form-control" id="cardNumber" 
                                               placeholder="1234 5678 9012 3456" value="4242 4242 4242 4242" readonly>
                                        <small class="text-muted">Demo card number</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="expiryDate" class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" id="expiryDate" 
                                               placeholder="MM/YY" value="12/28" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" 
                                               placeholder="123" value="123" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="firstName" 
                                               value="<%= currUser.profile && currUser.profile.firstName || 'Demo' %>" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="lastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="lastName" 
                                               value="<%= currUser.profile && currUser.profile.lastName || 'User' %>" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="paypal-details" class="payment-details" style="display: none;">
                            <div class="text-center p-4">
                                <i class="bi bi-paypal display-4 text-primary"></i>
                                <p class="mt-3">You will be redirected to PayPal to complete your payment.</p>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="#" target="_blank">Terms of Service</a> and 
                                    <a href="#" target="_blank">Privacy Policy</a>
                                </label>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="pay-button">
                                <i class="bi bi-lock"></i> Pay $<%= booking.totalPrice %>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="text-center mt-4">
                <small class="text-muted">
                    <i class="bi bi-shield-check"></i> 
                    Your payment information is secure and encrypted
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle payment method details
document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.payment-details').forEach(detail => {
            detail.style.display = 'none';
        });
        
        if (this.value === 'card') {
            document.getElementById('card-details').style.display = 'block';
        } else if (this.value === 'paypal') {
            document.getElementById('paypal-details').style.display = 'block';
        }
    });
});

// Form submission
document.getElementById('payment-form').addEventListener('submit', function(e) {
    const payButton = document.getElementById('pay-button');
    payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    payButton.disabled = true;
});
</script>
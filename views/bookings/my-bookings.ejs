<% layout("/layouts/boilerplate") %>

<style>
.booking-card {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.booking-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.booking-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.booking-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-confirmed {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.booking-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detail-item i {
    color: #6c757d;
    width: 16px;
}

.booking-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}

/* Responsive Design for My Bookings Page */
@media (max-width: 768px) {
    .container {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }

    .booking-card {
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .booking-details {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .booking-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .booking-actions {
        flex-direction: column;
        width: 100%;
    }

    .booking-actions .btn {
        width: 100%;
        margin: 0.25rem 0;
    }

    .detail-item {
        font-size: 0.9rem;
    }

    .empty-state {
        padding: 2rem 1rem;
    }

    .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }

    .row > * {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        margin-bottom: 1rem;
    }
}

@media (max-width: 576px) {
    .container {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .booking-card {
        padding: 0.75rem;
    }

    .detail-item {
        font-size: 0.85rem;
    }

    .empty-state {
        padding: 1.5rem 0.75rem;
    }
}
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6">My Bookings</h1>
                <a href="/listings" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Book New Stay
                </a>
            </div>

            <% if (bookings && bookings.length > 0) { %>
                <% bookings.forEach(booking => { %>
                    <div class="booking-card">
                        <div class="booking-header">
                            <div>
                                <h5 class="mb-1">
                                    <% if (booking.listing && booking.listing.title) { %>
                                        <%= booking.listing.title %>
                                    <% } else { %>
                                        Booking #<%= booking._id.toString().slice(-6) %>
                                    <% } %>
                                </h5>
                                <small class="text-muted">
                                    Booked on <%= new Date(booking.createdAt).toLocaleDateString() %>
                                </small>
                            </div>
                            <span class="booking-status status-<%= booking.status %>">
                                <% if (booking.status === 'confirmed') { %>
                                    <i class="bi bi-check-circle me-1"></i>Confirmed
                                <% } else if (booking.status === 'pending') { %>
                                    <i class="bi bi-clock me-1"></i>Pending
                                <% } else if (booking.status === 'cancelled') { %>
                                    <i class="bi bi-x-circle me-1"></i>Cancelled
                                <% } else { %>
                                    <i class="bi bi-info-circle me-1"></i><%= booking.status %>
                                <% } %>
                            </span>
                        </div>

                        <div class="booking-details">
                            <div class="detail-item">
                                <i class="bi bi-calendar-event"></i>
                                <span>
                                    <%= new Date(booking.checkIn).toLocaleDateString() %> - 
                                    <%= new Date(booking.checkOut).toLocaleDateString() %>
                                </span>
                            </div>
                            <div class="detail-item">
                                <i class="bi bi-people"></i>
                                <span><%= booking.guests %> guest<%= booking.guests > 1 ? 's' : '' %></span>
                            </div>
                            <div class="detail-item">
                                <i class="bi bi-moon"></i>
                                <span><%= booking.nights %> night<%= booking.nights > 1 ? 's' : '' %></span>
                            </div>
                            <div class="detail-item">
                                <i class="bi bi-currency-dollar"></i>
                                <span>₹<%= booking.total ? booking.total.toLocaleString() : 'N/A' %></span>
                            </div>
                            <% if (booking.paymentStatus) { %>
                            <div class="detail-item">
                                <i class="bi bi-credit-card"></i>
                                <span>
                                    Payment: 
                                    <% if (booking.paymentStatus === 'paid') { %>
                                        <span class="text-success">Paid</span>
                                    <% } else if (booking.paymentStatus === 'pending') { %>
                                        <span class="text-warning">Pending</span>
                                    <% } else { %>
                                        <span class="text-danger">Failed</span>
                                    <% } %>
                                </span>
                            </div>
                            <% } %>
                            <% if (booking.bookingReference) { %>
                            <div class="detail-item">
                                <i class="bi bi-hash"></i>
                                <span>Ref: <%= booking.bookingReference %></span>
                            </div>
                            <% } %>
                        </div>

                        <div class="booking-actions">
                            <% if (booking.status === 'confirmed') { %>
                                <a href="/bookings/<%= booking._id %>/confirmation" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Details
                                </a>
                                <% if (new Date(booking.checkIn) > new Date()) { %>
                                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal<%= booking._id %>">
                                        <i class="bi bi-x-circle me-1"></i>Cancel
                                    </button>
                                    
                                    <!-- Cancel Modal for each booking -->
                                    <div class="modal fade" id="cancelModal<%= booking._id %>" tabindex="-1" aria-labelledby="cancelModalLabel<%= booking._id %>" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header bg-light">
                                                    <h5 class="modal-title fw-bold" id="cancelModalLabel<%= booking._id %>">
                                                        <i class="bi bi-info-circle me-2 text-primary"></i>Booking Cancellation Policy
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body p-4">
                                                    <div class="alert alert-info mb-4">
                                                        <div class="d-flex">
                                                            <i class="bi bi-exclamation-circle fs-4 me-3 mt-1"></i>
                                                            <div>
                                                                <p class="mb-0">Please review our cancellation policy before proceeding. The refund amount depends on how far in advance you cancel.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                    
                                                    <h6 class="fw-bold mb-3">Refund Policy</h6>
                                                    <div class="table-responsive mb-4">
                                                        <table class="table table-bordered">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>When you cancel</th>
                                                                    <th>Refund amount</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td>More than 7 days before check-in</td>
                                                                    <td><span class="badge bg-success">100% refund</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>3-7 days before check-in</td>
                                                                    <td><span class="badge bg-warning text-dark">50% refund</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>1-3 days before check-in</td>
                                                                    <td><span class="badge bg-danger">25% refund</span></td>
                                                                </tr>
                                                                <tr>
                                                                    <td>Less than 24 hours before check-in</td>
                                                                    <td><span class="badge bg-dark">No refund</span></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                    
                                                    <% 
                                                    // Calculate refund amount based on current policy
                                                    const now = new Date();
                                                    const checkIn = new Date(booking.checkIn);
                                                    const daysUntilCheckIn = Math.ceil((checkIn - now) / (1000 * 60 * 60 * 24));
                                                    
                                                    let refundPercentage = 0;
                                                    let refundAmount = 0;
                                                    
                                                    if (daysUntilCheckIn > 7) {
                                                        refundPercentage = 100;
                                                        refundAmount = booking.total;
                                                    } else if (daysUntilCheckIn > 3) {
                                                        refundPercentage = 50;
                                                        refundAmount = booking.total * 0.5;
                                                    } else if (daysUntilCheckIn > 1) {
                                                        refundPercentage = 25;
                                                        refundAmount = booking.total * 0.25;
                                                    }
                                                    %>
                                    
                                                    <div class="card bg-light border-0 p-3 mb-4">
                                                        <h6 class="fw-bold">Your Cancellation Details</h6>
                                                        <p class="mb-2">Check-in date: <strong><%= new Date(booking.checkIn).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></strong></p>
                                                        <p class="mb-2">Time until check-in: <strong><%= daysUntilCheckIn %> days</strong></p>
                                                        <p class="mb-2">Booking total: <strong>₹<%= booking.total %></strong></p>
                                                        <p class="mb-2">Refund amount: <strong class="<%= refundPercentage >= 50 ? 'text-success' : refundPercentage > 0 ? 'text-warning' : 'text-danger' %>">₹<%= refundAmount.toFixed(2) %> (<%= refundPercentage %>%)</strong></p>
                                                    </div>
                                    
                                                    <div class="alert alert-warning mb-0">
                                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                                        <strong>Please note:</strong> Cancellation is irreversible. Once you cancel, you won't be able to reinstate this booking.
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                                                    <form action="/bookings/<%= booking._id %>/cancel" method="POST" style="display: inline;">
                                                        <button type="submit" class="btn btn-danger">
                                                            <i class="bi bi-x-circle me-1"></i>Confirm Cancellation
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            <% } else if (booking.status === 'pending' || booking.status === 'pending_payment') { %>
                                <a href="/bookings/<%= booking._id %>/confirmation" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Details
                                </a>
                                <% if (booking.paymentStatus === 'pending') { %>
                                    <a href="/bookings/<%= booking._id %>/payment" class="btn btn-primary btn-sm">
                                        <i class="bi bi-credit-card me-1"></i>Complete Payment
                                    </a>
                                <% } %>
                            <% } else { %>
                                <a href="/bookings/<%= booking._id %>/confirmation" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-eye me-1"></i>View Details
                                </a>
                            <% } %>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <h3>No bookings yet</h3>
                    <p class="mb-4">Start exploring amazing places to stay!</p>
                    <a href="/listings" class="btn btn-primary btn-lg">
                        <i class="bi bi-search me-2"></i>Browse Listings
                    </a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Cancel booking functionality now uses a form submission -->
